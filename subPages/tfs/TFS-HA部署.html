<!DOCTYPE html>
<html>
<head> 
  <meta charset="utf-8" /> 
  <meta http-equiv="X-UA-Compatible" content="chrome=1" /> 
  <link rel="stylesheet" type="text/css" href="../../stylesheets/stylesheet.css" media="screen" /> 
  <link rel="stylesheet" type="text/css" href="../../stylesheets/pygment_trac.css" media="screen" /> 
  <link rel="stylesheet" type="text/css" href="../../stylesheets/print.css" media="print" /> 
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--> 
    <title>TFS-HA部署</title> 
  </head> 
  <body> 
    <div id="container"> 
     <div class="inner"> 
      <header> 
       <h1><a style="color:#000" href="http://smartmz.github.io/" target="_blank">SmartMZ的Block</a></h1> 
       <h2>积累</h2> 
     </header> 
     <hr /> 
     <section id="main_content"> 
       <h3>【TFS】TFS-HA三种部署方案总结</h3> 
       <p>TaobaoFS搭建HA的三种方案</p> 
       <hr /> 
       <p>淘宝的TFS可以选择使用HA搭建，增强集群的高可用性。HA主要体现在NameServer节点的主备搭建。</p>
       <p>TFS的编译、安装和配置详情请参考官方网站：<a href="http://code.taobao.org/p/tfs/wiki/index/">http://code.taobao.org/p/tfs/wiki/index</a>，本文主要针对TFS-HA的部署做详细的说明。</p>
       <p>官方使用的Heartbeat是v3的版本，在机器级别可以对节点进行监控，如果其中一个NS机器宕机（或网络中断）后可以做出响应；如果需要进一步对NS节点的资源（Nameserver服务）进行监控，要使用CRM模式实现资源管理。</p>
       <p>Heartbeat v3已经将heartbeat、CRM拆分，heartbeat只负责心跳信息的通信，CRM部分主要有Pacemaker等实现资源管理，如果选择使用Pacemaker的话，还可以用CMAN来代替heartbeat. 因此，搭建TFS-HA集群时NS的主备部署有三种方式：</p>
       <ul>
         <li><a href="#q1">NameServer×2 + heartbeat + DataServer×N</a>，节点（机器）级别的HA</li>
         <li><a href="#q2">NameServer×2 + heartbeat + Pacemaker + DataServer×N</a>，资源级别的HA，官方</li>
         <li><a href="#q3">NameServer×2 + CMAN + Pacemaker + DataServer×N</a>，资源级别的HA</li>
       </ul>
       <p>HA需要两台独立的主机互为主备，并且要求这两台机器都直接互联的独立连接方式，有如下两种可选：
       <ul>
         <li>1.串口直连。</li>
         <li>2.网络直连线，要求HA主机有两个以上的网络接口，其中一个连接交换机，另外一个用于直连。本文使用这个方案。在实际生产环境中，推荐是两块网卡做BOND后进行直连，减小出错的几率。</li>
       </ul>
       <p>本次HA配置环境如下：</p>
       <table border="2px" cellpadding="3px" cellspacing="0px"> 
        <tbody>
         <tr> 
            <th width="30%">角色</th> 
            <th width="50%">IP / Hostname / Device</th> 
            <th width="20%">作用</th> 
         </tr> 
         <tr> 
            <td>NameServer</td> 
            <td>123.125.106.28 / tc28 / eth0外部 / eth3心跳</td> 
            <td>主NS</td> 
          </tr> 
          <tr> 
            <td>NameServer</td> 
            <td>123.125.106.24 / tc02402 / eth0外部 / eth3心跳</td> 
            <td>备NS</td> 
          </tr> 
          <tr> 
            <td>虚拟IP（VIP）</td> 
            <td>123.125.106.30 / eth0:0</td> 
            <td>集群接收和响应请求</td> 
          </tr>
        </tbody>
      </table>
      <br/>
      <p>系统的hosts配置：</p>
      <pre><code># cat /etc/hosts
123.125.106.28 tc28
123.125.106.29 tc02402</code></pre>
      <p>其他服务关闭</p>
      <pre><code># service iptables stop
# chkconfig iptables stop
# service NetworkManager stop
# chkconfig NetworkManager off</code></pre>
      <h4><a name="q1">NameServer×2 + heartbeat + DataServer×N</a></h4>
       <ul>
         <li>本次使用的软件版本为：
           <ul>
             <li>CentOS release 5.10 (Final) 2.6.18-371.11.1.el5 x86_64</li>
             <li>tfs-stable-2.0.1</li>
             <li>heartbeat-3.0.3-2.3.el5</li>
             <li>heartbeat-libs-3.0.3-2.3.el5</li>
             <li>cluster-glue-1.0.6-1.6.el5</li>
             <li>cluster-glue-libs-1.0.6-1.6.el5</li>
             <li>resource-agents-1.0.4-1.1.el5</li>
           </ul>
         </li>
         <li>heartbeat
           <p>heartbeat可以直接通过YUM源安装，也可以下载RPM或编译安装。Heartbeat v3安装过程中涉及到的配置文件说明参见<a href="./Heartbeat v3配置和资源运维.html">这里</a>。</p>
           <p>ha.cf的配置如下：</p>
           <pre><code># cat /etc/ha.d/ha.cf      
debugfile /data1/tfs/nameServer/logs/ha-debug
debug 1
keepalive 2
warntime 5
deadtime 10
initdead 30
auto_failback off
autojoin none
# 心跳线连接的设备，用于广播心跳信息
bcast eth3
udpport 694
node tc28
node tc02402
compression bz2
logfile /data1/tfs/nameServer/logs/ha-log
logfacility     local0
# 不采用2.x style的CRM(Pacemaker)，采用1.x style
<font style="color:#F00">crm off</font></code></pre>
            <blockquote>注意：主备节点上配置除了了路径外，其他内容最好保存一致。</blockquote> 
            <p>haresources的内容：</p>
            <pre><code># tc28为节点名，IPaddr为Heartbeat自带的一个脚本，123.125.106.30/24为需要设置的虚拟IP
tc28 IPaddr::123.125.106.30/24/eth0:0/</code></pre>
              <blockquote>注意：主备节点上的配置除了节点名以外，其他内容相同。</blockquote> 
              <p>配置好后，运行以下命令启动Heartbeat，就可以ping通虚拟IP 123.125.106.30了。</p>
              <pre><code># service heartbeat start</code></pre>
            </li>
            <li>两个NameServer节点的配置
              <p>参考官方文档：<a href="http://code.taobao.org/p/tfs/wiki/deploy/ns.conf">http://code.taobao.org/p/tfs/wiki/deploy/ns.conf</a></p>
            </li>
            <li>DataServer节点的配置
              <p>参考官方文档：<a href="http://code.taobao.org/p/tfs/wiki/deploy/ds.conf">http://code.taobao.org/p/tfs/wiki/deploy/ds.conf</a></p>
            </li>
          </ul>
          <p>启动NS和DS之后，TFS集群就可以使用了。通过Heartbeart，当其中主NS宕机以后，虚拟IP会自动落在备用的NS节点上，继续提供服务。</p>
          <p>NameServer×2 + heartbeat + DataServer×N的模式在节点级别对NS主备节点进行监控。但是如果其中一台机器没有宕机或下线，只是服务停止运行了，这种模式就无法检测到了。</p>
          <h4><a name="q2">NameServer×2 + heartbeat + Pacemaker + DataServer×N</a></h4>
          <ul>
           <li>本次使用的主要软件版本为：
             <ul>
               <li>CentOS release 5.10 (Final) 2.6.18-371.11.1.el5 x86_64</li>
               <li>tfs-stable-2.0.1</li>
               <li>heartbeat-3.0.3-2.3.el5</li>
               <li>heartbeat-libs-3.0.3-2.3.el5</li>
               <li>cluster-glue-1.0.6-1.6.el5</li>
               <li>cluster-glue-libs-1.0.6-1.6.el5</li>
               <li>resource-agents-1.0.4-1.1.el5</li>
             </ul>
           </li>
           在<a href="http://download.csdn.net/detail/smartmz/8460685">这里</a>(PART1)和<a href="http://download.csdn.net/detail/smartmz/8460703">这里</a>(PART2)下载全部RPM包。
           在TFS安装目录下包含了配置HA的配置文件和脚本，具体目录在$TFS_HOME/scripts/ha/。
           <li>配置ha.cf
              <pre><code># cat /etc/ha.d/ha.cf      
debugfile /data1/tfs/nameServer/logs/ha-debug
debug 1
keepalive 2
warntime 5
deadtime 10
initdead 30
auto_failback off
autojoin none
# 心跳线连接的设备，用于广播心跳信息
bcast eth3
udpport 694
node tc28
node tc02402
compression bz2
logfile /data1/tfs/nameServer/logs/ha-log
logfacility     local0
# 采用2.x style的CRM(Pacemaker)
<font style="color:#F00">crm respawn</font></code></pre>
              <p>拷贝ha.cf到目标目录</p>
              <pre><code># cp -f ha.cf /etc/ha.d/</code></pre>
            </li>
            <li>
              <p>生成authkeys</p>
              <pre><code># (echo -ne "auth 1\n1 sha1 ";dd if=/dev/urandom bs=512 count=1 | openssl md5) > authkeys.tmp</code></pre>
              <p>配置authkeys</p>
              <pre><code># cp -f authkeys.tmp /etc/ha.d/authkeys
# chmod 600 /etc/ha.d/authkeys
# chown root.root /etc/ha.d/authkeys</code></pre>
            </li>
            <blockquote>$TFS_HOME/scripts/ha/deploy脚本集成了以上工作，可以直接运行完成。</blockquote>
            <li>
              <p>配置资源脚本（服务脚本）</p>
              <pre><code># cp -f $TFS_HOME/scripts/ha/NameServer /usr/lib/ocf/resource.d/heartbeat/
# chmod u+x /usr/lib/ocf/resource.d/heartbeat/NameServer</code></pre>
            </li>
            <li>
              <p>配置完成后，启动heartbeat。</p>
              <pre><code># service heartbeat start</code></pre>
              <p>配置heartbeat运行属性</p>
            <pre><code># crm_attribute --type crm_config --attr-name symmetric-cluster --attr-value true
# crm_attribute --type crm_config --attr-name stonith-enabled --attr-value false
# crm_attribute --type rsc_defaults --name resource-stickiness --update 100</code></pre>
            <p>主要的设置为：1. 配置所有的节点为对等关系，即所有的节点都能接管服务；2. 禁用stonish</p>
            </li>
            <blockquote>注意：ha.cf和authkeys在主备节点上需要完全相同，建议手工拷贝的另一个节点上。尤其注意authkeys，是随机生成一段认证码，必须拷贝到另一个节点上。</blockquote>
            <li>
              <p>配置资源CIB</p>
              <p>CIB可以在heartbeat启动之前配置好（配置文件为：/var/lib/heartbeat/crm/cib.xml），也可以在启动后动态加入。本次采用动态加入的办法。$TFS_HOME/scripts/ha/ns.xml是要动态加入的资源。</p>
              <p>配置ns.xml（主要注意加了注释的地方）：</p>
              <pre><code>&ltresources&gt
  &ltgroup id="ns-group"&gt
    &ltprimitive class="ocf" id="ip-alias" provider="heartbeat" type="IPaddr2"&gt
      &ltinstance_attributes id="ip-alias-instance_attributes"&gt
        <font style="color:#F00">&lt!--设置为虚拟ip --&gt</font>
        &ltnvpair id="ip-alias-instance_attributes-ip" name="ip" value="123.125.106.30"/&gt
        <font style="color:#F00">&lt!-- 设置绑定的外网的设备(不是心跳线的设备，虚拟IP会落到这个设备上)--&gt</font>
        &ltnvpair id="ip-alias-instance_attributes-nic" name="nic" value="eth0:0"/&gt
      &lt/instance_attributes&gt
      &ltoperations&gt
        <font style="color:#F00">&lt!-- 监控的时间间隔 --&gt</font>
        &ltop id="ip-alias-monitor-2s" interval="2s" name="monitor"/&gt
      &lt/operations&gt
      &ltmeta_attributes id="ip-alias-meta_attributes"&gt
        &ltnvpair id="ip-alias-meta_attributes-target-role" name="target-role" value="Started"/&gt
      &lt/meta_attributes&gt
    &lt/primitive&gt
    <font style="color:#F00">&lt!-- 配置监控的脚本 --&gt</font>
    &ltprimitive class="ocf" id="tfs-name-server" provider="heartbeat" type="NameServer"&gt
      &ltinstance_attribute：s id="tfs-name-server-instance_attributes"&gt
        <font style="color:#F00">&lt!-- 配置为$TFS_HOME --&gt</font>
        &ltnvpair id="tfs-name-server-instance_attributes-basedir" name="basedir" value="/data1/tfs/nameServer"/&gt
        <font style="color:#F00">&lt!-- NameServer运行的主机 --&gt</font>
        &ltnvpair id="tfs-name-server-instance_attributes-nsip" name="nsip" value="localhost"/&gt
        <font style="color:#F00">&lt!-- NameServer运行的端口，和NS配置文件中配置的端口一致 --&gt</font>
        &ltnvpair id="tfs-name-server-instance_attributes-nsport" name="nsport" value="60000"/&gt
        <font style="color:#F00">&lt!-- NameServer运行的用户 --&gt</font>
        &ltnvpair id="tfs-name-server-instance_attributes-user" name="user" value="root"/&gt
      &lt/instance_attributes&gt
      &ltoperations&gt
        <font style="color:#F00">&lt!-- 定时检测NameSererver是否存活的间隔时间 --&gt</font>
        &ltop id="tfs-name-nameserver-monitor-2s" interval="2s" name="monitor"/&gt
        <font style="color:#F00">&lt!-- NameServer 启动超时间--&gt</font>
        &ltop id="tfs-name-nameserver-start" interval="0s" name="start" timeout="30s"/&gt
        <font style="color:#F00">&lt!-- NameServer 关闭超时间--&gt</font>
        &ltop id="tfs-name-nameserver-stop" interval="0s" name="stop" timeout="30s"/&gt
      &lt/operations&gt
      &ltmeta_attributes id="tfs-name-server-meta_attributes"&gt
        &ltnvpair id="tfs-name-server-meta_attributes-target-role" name="target-role" value="Started"/&gt
        &ltnvpair id="tfs-name-server-meta_attributes-resource-stickiness" name="resource-stickiness" value="INFINITY"/&gt
        &ltnvpair id="tfs-name-server-meta_attributes-resource-failure-stickiness" name="resource-failure-stickiness" value="-INFINITY"/&gt
      &lt/meta_attributes&gt
    &lt/primitive&gt
  &lt/group&gt
&lt/resources&gt</code></pre>
              <p>动态添加CIB资源</p>
              <blockquote>注意：添加资源后heartbeat将主动拉起主节点上的Nameserver服务，因此在添加资源之前应该完成Nameserver的配置。</blockquote>
              <pre><code># cibadmin --replace --obj_type=resources --xml-file $TFS_HOME/scripts/ha/ns.xml</code></pre>
              <p>通过以下命令查看HA主备节点的状态</p>
              <pre><code># crm status
============
Last updated: Fri Feb 27 17:34:48 2015
Stack: Heartbeat
Current DC: tc28 (4ac4335a-1d77-47fc-8354-cd9a06887d6e) - partition with quorum
Version: 1.0.12-unknown
2 Nodes configured, unknown expected votes
1 Resources configured.
============

Online: [ tc02402 tc28 ]

 Resource Group: ns-group
     ip-alias   (ocf::heartbeat:IPaddr2):       Started tc28
     tfs-name-server    (ocf::heartbeat:NameServer):    Started tc28</code></pre>
            </li>
            <li>主备切换
            <p>该HA模式下，如果主节点上的NameServer服务宕掉，HA会自动拉起另一个节点上的NameServer服务，并且将虚拟IP漂移到另一个节点上。这样就实现了资源级别的HA。</p>
            <p>这里需要注意的是，服务已经迁移到备节点上后，如果备节点也宕掉，HA不会主动拉起主节点上的NameServer服务。要想HA能够自动重新拉起主节点上的服务，需要运行以下命令将主节点的错误标记清0：</p>
            <pre><code># crm resource failcount tfs-name-server set tc28 0</code></pre>
            <p>可以在crontab里添加一个脚本，定时清0节点上的错误标记。</p></li>
         </ul>
         <h4><a name="q3">NameServer×2 + CMAN + Pacemaker + DataServer×N</a></h4>
         <p>该模式实现的目标和上一模式是一样的，记录的原因是之前遇到过在高版本的CentOS环境中上一模式无法成功运行heartbeat，因此可以将这一方案作为备选方案。</p>
         <ul>
           <li>本次使用的软件均为YUM安装，版本为：
             <ul>
               <li>CentOS CentOS release 6.6 (Final) 2.6.32-431.11.2.el6.toa.2.x86_64</li>
               <li>tfs-stable-2.0.1</li>
               <li>pacemaker-1.1.12-4.el6.x86_64</li>
               <li>cman-3.0.12.1-68.el6.x86_64</li>
               <li>pcs-0.9.123-9.0.1.el6.centos.x86_64（非必须，方便集群配置管理）</li>
               <li>ccs-0.16.2-75.el6.x86_64（非必须，方便集群配置管理）</li>
               <li>resource-agents-3.9.5-12.el6_6.2.x86_64</li>
             </ul>
           </li>
           <li>CMAN配置和启动
            <ul>
              <li>配置集群信息
                <p>主要是对/etc/cluster/cluster.conf进行配置，ccs提供了相关工具对该文件进行配置。<br/>先加入两个NS节点：</p>
                <pre><code># ccs -f /etc/cluster/cluster.conf --addnode tc28
# ccs -f /etc/cluster/cluster.conf --addnode tc02402</code></pre>
                <p>配置属性：</p>
                <pre><code># ccs -f /etc/cluster/cluster.conf --addfencedev pcmk agent=fence_pcmk
# ccs -f /etc/cluster/cluster.conf --addmethod pcmk-redirect tc28
# ccs -f /etc/cluster/cluster.conf --addmethod pcmk-redirect tc02402
# ccs -f /etc/cluster/cluster.conf --addfenceinst pcmk tc28 pcmk-redirect port=tc28
# ccs -f /etc/cluster/cluster.conf --addfenceinst pcmk tc02402 pcmk-redirect port=tc02402
# echo "CMAN_QUORUM_TIMEOUT=0" >> /etc/sysconfig/cman</code></pre>
                <p>启动CMAN：</p>
                <pre><code># service cman start</code></pre>
                <blockquote>如果这里不启动cman，也可以在下面直接启动Pacemaker。配置属性也在后面进行。</blockquote>
                <p>设置属性：</p>
                <pre><code># crm_attribute --type crm_config --attr-name symmetric-cluster --attr-value true  
# crm_attribute --type crm_config --attr-name stonith-enabled --attr-value false 
# crm_attribute --type rsc_defaults --name resource-stickiness --update 100</code></pre>
              </li>
            </ul>
           </li>
           <li>Pacemaker配置
            <ul>
              <li>建立组和用户（YUM安装无需建立）
              <pre><code># groupadd haclient
# useradd -g haclient hacluster -M -s /sbin/nologin</code></pre>
              </li>
              <li>启动Pacemaker
              <pre><code># chkconfig pacemaker on
# service pacemaker start</code></pre>
              </li>
              <li>配置属性
              <pre><code># pcs property set stonith-enabled=false
# pcs property set no-quorum-policy=ignore
# pcs resource defaults migration-threshold=1</code></pre>
              </li>
              <li>配置cib.xml和添加资源
                <p>添加OCF_ROOT环境变量：</p>
                <pre><code># echo "export OCF_ROOT=/usr/lib/ocf" >> /etc/profile
# source /etc/profile</code></pre>
                <p>采用动态添加资源的方法加入NameServer资源，cib.xml配置参考上一模式中的“配置资源CIB”小节。</p>
                <blockquote>注意：在添加CIB资源时，cibadmin命令与上一模式的版本不同，参数有变，运行以下命令即可：
                  <pre><code># cibadmin --replace –scope resources --xml-file $TFS_HOME/scripts/ha/ns.xml</code></pre>
                  <p>同样注意，在添加CIB资源之前需要先完成NS的配置。</p>
                </blockquote>
              </li>
              <li>查看集群状态：
                <pre><code># crm_mon -1
Last updated: Fri Feb 27 19:02:40 2015
Last change: Wed Feb  4 13:43:26 2015
Stack: cman
Current DC: tc28 (4ac4335a-1d77-47fc-8354-cd9a06887d6e) - partition with quorum
Version: 1.1.11-97629de
2 Nodes configured
2 Resources configured

Online: [ tc02402 tc28 ]

 Resource Group: ns-group
     ip-alias   (ocf::heartbeat:IPaddr2):       Started tc28
     tfs-name-server    (ocf::heartbeat:NameServer):    Started tc28 </code></pre>
              </li>
              <li>主备切换
                <p>该HA模式下，如果主节点上的NameServer服务宕掉，HA会自动拉起另一个节点上的NameServer服务，并且将虚拟IP漂移到另一个节点上。这样就实现了资源级别的HA。</p>
                <p>同上一模式需要注意的一样，服务已经迁移到备节点上后，如果备节点也宕掉，HA不会主动拉起主节点上的NameServer服务。要想HA能够自动重新拉起主节点上的服务，需要运行以下命令将主节点的错误标记清0：</p>
                <pre><code># crm resource failcount tfs-name-server show tc28
# crm resource failcount tfs-name-server set tc28 0</code></pre>
                <p>可以在crontab里添加一个脚本，定时清0节点上的错误标记。</p>
              </li>
            </ul>
           </li>
         </ul>
       </section> 
       <footer>
        This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>. 
      </footer> 
    </div> 
  </div>   
  </body>
  </html>