---
layout: post
title: "淘宝追踪系统-鹰眼"
date: 2016-08-24 12:25
keywords: trace, EagleEye
description: TaoBao的EagleEye
categories: [Trace]
tags: [trace]
group: Trace
icon: globe
---

<!-- more -->

# 淘宝-鹰眼（EagleEye）

追踪每个请求的完整调用链路，收集调用链路上每个服务的性能数据，计算性能数据和比对性能指标（SLA）。

## 功能

基于日志，每次请求生成全局唯一的TraceId，通过它将不同系统的孤立日志串联重组，还原调用链信息。

### 调用链跟踪（展现单条调用链）

![调用](http://ww1.sinaimg.cn/mw690/a8484315jw1f74w9qt1zvj212m0qralh.jpg)

 * 同一次请求的所有相关调用的情况，称作调用链，在前端请求到达服务器时，为这个请求分配一个全局唯一的调用链TraceId。TraceId的生成需要考虑是否包含业务语义（比如前端IP地址、创建时间、顺序序号、进程号、标志位等）。
 * 调用链上的每次调用内部生成RpcId，用于区分同一个调用链下的多个网络调用的发生顺序和嵌套层次关系。对于前端收到请求，RpcId固定是0。RpcId按序列多级叠加，形成树。RpcId的生成需要考虑支持同步调用、异步调用、一对多调用等情况。

	>	在上图一个非常简单的分布式调用场景里做的事情，就是为每次调用分配 TraceId、RpcId，调用结束的时候，把 TraceId、RpcId 打印到访问日志。访问日志里面，一般会记录调用开始时间、远端IP地址、调用类型、结果状态码ResultCode、调用耗时、请求传输量之类，也会记录与这次调用类型相关的一些信息，如URL、服务名、消息topic等，这里统一称为调用上下文。调用开始时，调用上下文保存在ThreadLocal，调用结束后清理。遇到异步、单向、广播、并发、批处理等情况，需要妥善处理好ThreadLocal上的调用上下文，避免调用上下文混乱和无法正确释放。

 * 应用报异常或处理超时,在日志打印当前调用链 TraceId，同时关联打印链路上下文抛出的异常堆栈和服务器的CPU Load、JVM、IO、网络状况等

### 链路分析（统计分析多条调用链）

 * 跨级别进行容量规划

	>	![](http://ww2.sinaimg.cn/mw690/a8484315jw1f74w8ma1fkj20nu0d1tbj.jpg)   
	>	得到对间接依赖、异步依赖的调用量

 * 检查调用来源

 * 度量依赖
 
	>	强依赖: 调用失败会直接中断主流程   
	>	高度依赖: 一次链路中调用某个依赖的几率高   	>	频繁依赖: 一次链路调用同一个依赖的次数多   
 
 * 监控调用耗时，找到瓶颈
 *	分析调用并行度
 
	>	![分析并行度](http://ww1.sinaimg.cn/mw690/a8484315jw1f74w8ms615j21bq0k2n2k.jpg)   
	
 * 调用路由情况
 
	>	调用分布是否均衡，是否存在热点    
	>	检验网络路由是否正常，是否封闭    

### 透明数据传输（调用链与业务数据集成）

 * 鹰眼自身需要传递调用上下文信息，可以在调用链上同时透明传输业务数据

	>	传递特定环境的标识，用于调用路由判断和控制    
	>	传递调试指令，操作后端服务    
	>	把前端应用特有的数据传到若干层后端的某个服务中   

## 架构机制

![整体架构](http://ww2.sinaimg.cn/mw690/a8484315jw1f74w8p4ajzj21cf0uqaof.jpg)

* 中间件：应用容器的过滤器，在执行实际业务处理之前执行埋点逻辑，向本地trace日志文件写入包含调用上下文的日志，在本地TreadLocal中保存调用上下文，对业务透明。不同调用级别的中间件之间可以通过网络请求传递调用上下文。每个调用开始创建上下文，结束时清理上下文。

	>	![埋点和输出日志](http://ww4.sinaimg.cn/mw690/a8484315jw1f74w8omhk3j21du0staos.jpg)    
	>	自己实现日志输出：异步线程写日志；对调用链采样；开关降级控制；对服务等长字符串做编码；日志输出缓存,限制IO次数,按秒刷新；日志文件按大小滚动,自动清理；统一字符编码,统一时区
	
* 日志收集agent：读取本地trace日志文件，将数据推出。
* Storm集群：实时收集多个日志收集agent推送的日志，汇总后，一方面推送给HBase做实时分析，另一方面推送给HDFS备份做离线分析。
* HBase：进行实时统计，供Eagleeye Server提取实时数据（调用耗时、调用异常、调用链等）。
* HDFS：顺序存储全量数据，定时通过Hadoop集群对数据进行汇总和离线计算，将计算结果保存到HDFS，供EagleEye Server提取其他数据（调用链路结构、依赖度等）。
* 鹰眼服务器：数据可视化。

## 可视化

### 调用链展示界面

  ![调用蓝界面](http://ww2.sinaimg.cn/mw690/a8484315jw1f74ymv6pfnj20qb0gbqba.jpg)

 * 左侧是调用链，树状结构，可以展开。按照应用（接口）维度。
 * 中间是每条调用链各个调用的类型、响应大小、返回状态等指标。
 * 右侧是每条调用链各个调用的耗时，体现并行度。
 * 如果某个调用出现异常，该次调用标红，级联到上级调用。

### 分析链界面

  ![分析链界面](http://ww4.sinaimg.cn/mw690/a8484315jw1f74yw3t2tvj21hb0vfnds.jpg)

 * 对调用的横向对比，分析展示调用的依赖度、调用频次、耗时和峰值等。
 
## 存储

* 供实时分析存储：HBase
* 供离线分析存储：HDFS

## 其他

* 入侵程度：应用容器依赖鹰眼的中间件（Filter），调用上下文通过中间件传输，不入侵业务代码。
* 检测粒度：接口级别。
* 插件：不支持第三方插件。

## 参考资料

http://www.cnblogs.com/zhengyun_ustc/p/55solution2.html   
http://vdisk.weibo.com/s/9G9ufMjab8Y



