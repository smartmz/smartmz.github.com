---
layout: post
title: "通讯业务保障的思路"
date: 2016-05-30 08:00
keywords: garantee
description: 通讯业务保障的思路
categories: [system]
tags: [structure]
group: archive
icon: globe
---

业务保障流程主要包括问题的预防、发现、定位、快速处理、解决等步骤，在目前已有基础设施的基础上，每部分内部可以通过多种手段增强自动化能力和数据分析能力，更早更快发现业务体系中的问题并采取措施，压缩保障时间，不断提高保障效率。

业务保障一方面依靠业务工程自身能够输出规范有效的监控数据和预留的干预能力，另一方面依靠运维同学在运维层面的干预能力。下面分别对这几部分进行说明。

<!-- more -->

<center style="width:700px;padding-left:50px;">![](http://ww3.sinaimg.cn/large/a8484315jw1f4l5yj0mwoj20l607pjsu.jpg)</center>

### _预防_

工程研发过程中，首先根据规范输出精炼有效的日志是业务保障的开始，问题能否快速发现能否快速定位，日志是关键。其次，根据经验和以往的保障标准需要在源码层面加入对可能出现问题的预防措施，最常见的比如在链路的长耗时节点处利用**快速失败、限速**等方式防止耗时过长导致任务阻塞进而影响系统性能；再如，在链路的重依赖节点出利用**线程限制、降级机制**等方式防止依赖方出现问题时造成雪崩；另外，根据实际的业务情况将上下行分离，分别采取保障措施也是一种手段。

* 快速失败
* 限速
	* 线程池
	* 可柱塞的队列
	* 架构上设计一层通道用于任务传递，和业务逻辑本身解耦
* 线程限制
* 开关降级

### _发现_

发现业务问题，主要通过**实时监控报警、离线分析预警**等手段。实时监控报警需要覆盖视图、声音、邮件、微博、短信等多种渠道让运维和研发尽可能早的发现线上此时此刻接口提供服务异常、流量异常等；离线分析预警手段需要对历史监控数据进行分析比对，尽可能早的发现线上服务接口在服务压力、报错量、耗时等方面，服务资源在负载、性能方面的变化趋势。

<center style="width:500px;padding-left:50px;">![](http://ww2.sinaimg.cn/large/a8484315jw1f4l5yitpkyj20ev06gt9w.jpg)</center>

####  实时接口监控报警

1. 直接手段
实时发现线上此时此刻接口提供服务异常

	1. 探测式报警
		* 接口-服务异常

	2. Grafana、Alert.Noc监控报警
		* 接口-2xx, 4xx， 5xx, 耗时
		* RPC-请求量，错误量，耗时
		* 资源-请求量，错误量，耗时

	3. 突变报警
		* 接口-2xx, 4xx， 5xx, 耗时

	4. 外围监控
		* RPC-down，up
		* 硬件-load，memory，swap，cpu....

	5. SinaWatch
		* 硬件-load，memory，swap，cpu, 网络...

2. 增强
快速高效地为业务配备完善的监控手段

	1. Grafana自动生成
		* 根据服务识别当前可支持监控项目（涵盖接口、链路、资源）
		* 针对一个业务自动生成Grafana，涵盖接口的调用情况、业务链路上各个节点的依赖调用情况和对资源的调用情况
	
	2. Grafana声音监控
		* 为Grafana提供实时声音报警（基于阈值）
		
	3. 灰度预览自动监控
		* 接入上线系统，业务预览、灰度时自动生成针对IP的接口监控（4xx,5xx,cost）
	
#### 离线分析预警

1. 趋势比对
按日(周、月)比对指标变化趋势

	* 接口调用量
	* 接口耗时
	
2. 邮件聚合分析
按日(周、月)分类统计报警邮件

	* 哪类报警本日(周、月)尚未处理
	* 哪些类型(内容)的报警居高不下
	* 哪些类型(内容)的报警有上升趋势
	* 根据预设 针对重点报警聚合达到次数升级报警手段

### _定位_

定位问题遵循 **面 > 线 > 点** 的顺序，依靠报警信息可以初步定位问题业务(面)，依靠完整的Grafana监控视图可以初步定位问题链路(接口、依赖、资源)(线)，依靠日志具体定位问题位置(点)。相关工具主要提高定位具体问题位置的能力和效率。

<center style="width:500px;padding-left:50px;">![](http://ww2.sinaimg.cn/mw690/a8484315jw1f4l5yj2y17j209406uwf9.jpg)</center>

1. 日志规范化

	* 日志Json化
	* 添加必要的链路日志(watch-man)
		* 减少业务入侵
		* 快速从业务降级
	
2. 异常日志聚合
按照时长间隔拉取并按照错误类型聚合业务日志中WARN、ERROR日志(统称为“异常日志”)

	* 各个类型异常日志的数量
	* 异常日志按数量排名
	* 某类异常日志近期的增长曲线
	* 动态拉取异常日志上下文

3. 日志快速检索

	* wtool集成常用检索功能模板
	* Json规范日志输出（其他组支持）和ELK检索

### _处理_

处理问题不是解决问题，是快速恢复服务，通过功能降级、封杀、切量、扩容等操作将问题服务隔离，保证整体服务可用。

<center style="width:500px;padding-left:50px;">![](http://ww1.sinaimg.cn/mw690/a8484315jw1f4l5yj1gewj20940590t2.jpg)</center>

1. 降级

	* 统一各业务开关机制
	* 开关自动提取
	* 通过界面系统提供开关查询、切换操作，降低操作成本

2. 接口封杀

	* 统一各业务服务接口封杀机制
	* 结合*日志快速检测*支持针对IP、UID、SOURCE、正则表达

3. 切量

	* @运维

4. 扩容

	* 上云

### _解决_

解决问题是在处理线上问题以后，查找链路薄弱环节、代码漏洞的过程。根据线上问题的定位，针对性修复。修复过程包括测试、预览、灰度和上线。

1. 集成测试
2. 预览、灰度	

