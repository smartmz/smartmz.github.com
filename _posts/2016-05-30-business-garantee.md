---
layout: post
title: "通讯业务保障的思路"
date: 2016-05-30 08:00
keywords: garantee
description: 通讯业务保障的思路
categories: [system]
tags: [structure]
group: archive
icon: globe
---
业务保障流程主要包括问题的预防、发现、定位、快速处理、解决等步骤，在目前已有基础设施的基础上，每部分内部可以通过多种手段增强自动化能力和数据分析能力，更早更快发现业务体系中的问题并采取措施，压缩保障时间，不断提高保障效率。

业务保障一方面依靠业务工程自身能够输出规范有效的监控数据和预留的干预能力，另一方面依靠运维同学在运维层面的干预能力。下面分别对这几部分进行说明。

<!-- more -->

<center style="width:700px;padding-left:50px;">![](http://ww3.sinaimg.cn/large/a8484315jw1f4l5yj0mwoj20l607pjsu.jpg)</center>

### _预防_

工程研发过程中，首先根据规范输出精炼有效的日志是业务保障的开始，问题能否快速发现能否快速定位，日志是关键。其次，根据经验和以往的保障标准需要在源码层面加入对可能出现问题的预防措施，最常见的比如在链路的长耗时节点处利用**快速失败、限速**等方式防止耗时过长导致任务阻塞进而影响系统性能；再如，在链路的重依赖节点出利用**线程限制、降级机制**等方式防止依赖方出现问题时造成雪崩；另外，根据实际的业务情况将上下行分离，分别采取保障措施也是一种手段。

* 日志
	* 结构化日志+Profile+Scribe
		* **日志Json化**：结构化日志提高后期对日志的处理能力 <目前在群聊工程中已经实现了关键路径日志的Json化>
		* 通用的VIP_log：Log4j-只有满足filter条件才能打印出对应日志
		* 通用的requestID：Log4j2-MDC

	* 配合接入watchman
		* 减少业务入侵
		* 快速从业务降级
		
* 熔断机制
	* Hystrix
		* 快速失败
		* Failback策略
* 限速
	* 单机：可阻塞的容器（Guava的RateLimiter）
	* 全局：架构上设计Q用于任务传递，和业务逻辑本身解耦（Kafka可阻塞）
		* 拆分非核心队列   
			
* 开关降级
	* cn.sina.api.commons.util.Switcher
	* **SwitcherScan**：提供了开关自动扫描并同步到Git上的功能 <完成> [示例](http://git.intra.weibo.com/im/doc/tree/master/switcher)

### _发现_

快速发现业务问题，主要通过**实时监控报警、离线分析预警**等手段快速通知相关负责人关注业务问题，报警的详细信息作为发现阶段的产出通过邮件、报告等方式传递给定位阶段。

<center style="width:500px;padding-left:50px;">![](http://ww2.sinaimg.cn/large/a8484315jw1f4l5yitpkyj20ev06gt9w.jpg)</center>

#### 实时监控

报警需要覆盖视图、声音、邮件、微博、短信等多种渠道让运维和研发尽可能早的发现线上此时此刻接口提供服务异常、流量异常等；
	
1. 基础设施（100%）
	
	1. 探测式报警
		* 接口-服务异常
	2. Grafana、Alert.Noc监控报警
		* 接口-2xx, 4xx， 5xx, 耗时
		* RPC-请求量，错误量，耗时
		* 资源-请求量，错误量，耗时
	3. 突变报警
		* 接口-2xx, 4xx， 5xx, 耗时
	4. 外围监控
		* RPC-down，up
		* 硬件-load，memory，swap，cpu....
	5. SinaWatch
		* 硬件-load，memory，swap，cpu, 网络...

2. 增强工作
	
	1. **探测报警**：直接探测服务接口功能是否正常，高效准确 <通讯核心业务已经接入>
	2. **突变报警**：在一定时间内错误量、流量波动超过阈值触发 <需优化>
	3. **Grafana声音报警**：为Grafana提供声音报警，曲线超过阈值触发 <完成> [示例](http://10.75.0.24:8888/dashboard/db/msg_center_tv_alert)
	4. **Grafana自动编排**：为业务接口、资源、链路等提供Grafana监控配置建议，并且提供一键生成Dashboard功能 <开发中，目前支持业务接口2xx、4xx、5xx、cost等指标的实时监控图、TopN监控图、历史曲线对比图> [示例](http://127.0.0.1:7070/)
	5. **灰度预览自动监控**：*Grafana自动编排* 接入预览系统，业务预览、灰度时自动生成针对IP的接口监控

#### 离线分析预警

目前这一部分比较欠缺，需要对历史监控数据进行分析比对，尽可能早的发现线上服务接口在服务压力、报错量、耗时等方面，服务资源在负载、性能方面的变化趋势，根据处理延时逐步提高报警级别。

* **指标趋势比对**：根据统计的数据信息，按照日、周、月的时间间隔对指标进行比对，发现业务趋势、指标走向，提供措施建议 <排期中>

* **邮件聚合分析**：按照日、周、月的时间间隔过滤统计报警邮件，形成报警简报，通过报警频率、报警起止等判断业务薄弱环节和处理情况，动态提升或降低报警级别 <开发中>
		* 哪类报警本日(周、月)尚未处理
		* 哪些类型(内容)的报警居高不下
		* 哪些类型(内容)的报警有上升趋势
		* 根据预设 针对重点报警聚合达到次数升级报警手段

### _定位_

快速定位问题遵循 **面 > 线 > 点** 的顺序，依靠发现环节输出的各类信息初步定位问题业务(面)，依靠完整的Grafana监控视图可以初步定位问题链路(接口、依赖、资源)(线)，依靠日志具体定位问题位置(点)。相关工具主要提高定位具体问题位置的能力和效率。

<center style="width:500px;padding-left:50px;">![](http://ww2.sinaimg.cn/mw690/a8484315jw1f4l5yj2y17j209406uwf9.jpg)</center>

1. 目前状态
	1. 面：根据发现阶段的输出信息可以定位问题业务
	2. 线：大多数情况下根据发现阶段的监控图、报警内容可以定位到服务的链路，但是如果涉及到这个产品线（端上+平台+资源+三方依赖），有时会出现脱节的情况
	3. 点：少数情况下可以直接定位，多数情况下需要进行时间比较长的确认。如果不能直接定位问题，往往会直接通过运维去快速应对问题，优先恢复线上服务

2. 增强工作
	1. **异常日志聚合** <开发中> 按照时长间隔拉取并按照错误类型聚合业务日志中WARN、ERROR日志(统称为“异常日志”)
	2. 各个类型异常日志的数量
	3. 异常日志按数量排名
	4. 某类异常日志近期的增长曲线
	5. 动态拉取异常日志上下文

* 日志快速检索
	* wtool集成常用检索功能模板
	* Json规范日志输出和ELK检索（其他组支持）

### _处理_

处理问题不是解决问题，是快速恢复服务，通过回滚、功能降级、封杀、切量、扩容等操作将问题服务恢复或者隔离，保证整体服务可用。

<center style="width:500px;padding-left:50px;">![](http://ww1.sinaimg.cn/mw690/a8484315jw1f4l5yj1gewj20940590t2.jpg)</center>

1. 开关降级
	* **SwitchTool**：统一各业务开关机制和切换开关的方法，并提供用户界面简化操作，支持以往的NC类开关和DB类开关，废弃JSP类的开关 <通讯核心业务已经接入> [示例](http://127.0.0.1:7070/)

2. 接口封杀
	* **封杀工具**：在服务级别提供封杀功能，对入侵请求进行快速封杀 <通讯核心业务已接入>
		* 支持针对IP、UID、SOURCE、正则表达 <完成>
		* 合入运维封杀系统 <完成>

3. 切量
	* @运维

4. 扩容
	* 上云 @运维

### _解决_

解决问题是在处理线上问题以后，查找链路薄弱环节、代码漏洞的过程。根据线上问题的定位，针对性修复。修复过程包括测试、预览、灰度和上线。

1. 在源码层面根治问题
2. check list，发现并解决其他业务中的类似问题
3. 集成测试、预览、灰度	

